{% extends 'base.html' %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Game #{{ game.id }}</h1>

<div id="timer" class="text-2xl font-bold mb-4">Time left: <span id="countdown"></span></div>

<div class="flex">
    <div class="w-2/3 pr-4">
        <form id="answer-form" action="{{ url_for('main.submit_answers', game_id=game.id) }}" method="POST">
            {% for question in questions %}
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="question-{{ question.id }}">
                    {{ question.phrase }}
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                    id="question-{{ question.id }}" 
                    name="answers[]" 
                    type="text" 
                    placeholder="Your answer">
            </div>
            {% endfor %}
            <input type="hidden" name="ethereum_address" id="ethereum-address" value="{{ player_address }}">
            <button id="submit-answers-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" 
                    type="submit">
                Submit Answers
            </button>
        </form>
    </div>

    <div class="w-1/3 pl-4">
        <div id="leaderboard" class="bg-white shadow-md rounded px-8 pt-6 pb-8">
            <h2 class="text-2xl font-bold mb-4">Live Leaderboard</h2>
            <ul id="player-scores">
                {% for player in players %}
                <li class="mb-2 p-2 rounded {% if player.ethereum_address == player_address %}bg-yellow-100{% endif %}" data-player-address="{{ player.ethereum_address }}">
                    {{ player.ethereum_address[:6] }}...{{ player.ethereum_address[-4:] }}: <span class="score">{{ player.score }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let timer;
let timeLeft = {{ game.time_limit }};
const gameId = {{ game.id }};
const playerEthereumAddress = document.getElementById('ethereum-address').value;

function startTimer() {
    timer = setInterval(function() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        
        document.getElementById('countdown').textContent = 
            (minutes < 10 ? "0" + minutes : minutes) + ":" + 
            (seconds < 10 ? "0" + seconds : seconds);
        
        if (--timeLeft < 0) {
            clearInterval(timer);
            submitAnswers();
        }
    }, 1000);
}

function submitAnswers() {
    const form = document.getElementById('answer-form');
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        alert(data.message);
        if (data.game_complete) {
            window.location.href = "{{ url_for('main.game_result', game_id=game.id) }}";
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while submitting answers. Please try again.');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const socket = io('/game');
    socket.emit('join', { game_id: gameId });

    socket.on('connect', () => {
        console.log('Socket connected!');
    });

    socket.on('game_started', function(data) {
        if (data.game_id === gameId) {
            alert('The game has started!');
            startTimer();
        }
    });

    socket.on('player_score_update', function(data) {
        if (data.game_id === gameId) {
            updateLeaderboard(data);
        }
    });

    socket.on('game_complete', function(data) {
        if (data.game_id === gameId) {
            clearInterval(timer);
            alert('Game has ended! Redirecting to results page...');
            window.location.href = "{{ url_for('main.game_result', game_id=game.id) }}";
        }
    });

    socket.on('connect_error', (err) => {
        console.error('Connection Error: ', err);
        alert('Unable to connect to the game server. Please refresh the page and try again.');
    });
});

function updateLeaderboard(data) {
    const playerScores = document.getElementById('player-scores');
    let playerItem = playerScores.querySelector(`[data-player-address="${data.player_address}"]`);
    
    if (playerItem) {
        playerItem.querySelector('.score').textContent = data.score;
    } else {
        playerItem = document.createElement('li');
        playerItem.className = 'mb-2 p-2 rounded';
        playerItem.setAttribute('data-player-address', data.player_address);
        
        if (data.player_address === playerEthereumAddress) {
            playerItem.classList.add('bg-yellow-100');
        }
        
        const truncatedAddress = `${data.player_address.slice(0, 6)}...${data.player_address.slice(-4)}`;
        playerItem.innerHTML = `${truncatedAddress}: <span class="score">${data.score}</span>`;
        
        playerScores.appendChild(playerItem);
    }

    // Sort the leaderboard
    const players = Array.from(playerScores.children);
    players.sort((a, b) => {
        const scoreA = parseInt(a.querySelector('.score').textContent);
        const scoreB = parseInt(b.querySelector('.score').textContent);
        return scoreB - scoreA;
    });
    players.forEach(player => playerScores.appendChild(player));
}

startTimer();
</script>
{% endblock %}
