{% extends 'base.html' %}

{% block content %}
<div class="futuristic-container">
    <h1 class="text-3xl font-bold mb-6 neon-text">Game #{{ game.id }}</h1>

    <div id="timer" class="text-2xl font-bold mb-4 neon-clock">Time left: <span id="countdown"></span></div>

    <div class="flex flex-wrap">
        <div class="w-full lg:w-2/3 pr-4">
            <form id="answer-form" action="{{ url_for('main.submit_answers', game_id=game.id) }}" method="POST">
                {% for question in questions %}
                <div class="mb-4">
                    <label class="block text-white text-sm font-bold mb-2" for="question-{{ question.id }}">
                        {{ question.phrase }}
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-300 leading-tight focus:outline-none focus:shadow-outline" 
                        id="question-{{ question.id }}" 
                        name="answers[]" 
                        type="text" 
                        placeholder="Your answer">
                </div>
                {% endfor %}
                <input type="hidden" name="ethereum_address" id="ethereum-address" value="{{ player_address }}">
                <button id="submit-answers-btn" class="neon-button" type="submit">
                    Submit Answers
                </button>
            </form>
        </div>
        
        <div class="w-full lg:w-1/3 mt-4 lg:mt-0">
            <div class="leaderboard">
                <h2 class="leaderboard-title">Live Leaderboard</h2>
                <ul id="leaderboard-list" class="leaderboard-list">
                    <!-- Leaderboard items will be dynamically updated -->
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let timer;
let timeLeft = {{ game.time_limit }};
const gameId = {{ game.id }};
const playerAddress = "{{ player_address }}";

function startTimer() {
    timer = setInterval(function() {
        const seconds = timeLeft % 60;
        
        document.getElementById('countdown').textContent = (seconds < 10 ? "0" + seconds : seconds);
        
        if (--timeLeft < 0) {
            clearInterval(timer);
            submitAnswers();
        }
    }, 1000);
}

function submitAnswers() {
    const form = document.getElementById('answer-form');
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        alert(data.message);
        if (data.game_complete) {
            window.location.href = "{{ url_for('main.game_result', game_id=game.id) }}";
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while submitting answers. Please try again.');
    });
}

function updateLeaderboard(data) {
    const leaderboardList = document.getElementById('leaderboard-list');
    const playerItem = leaderboardList.querySelector(`[data-player-address="${data.player_address}"]`);

    if (!playerItem) {
        const newPlayerItem = document.createElement('li');
        newPlayerItem.className = 'leaderboard-item';
        newPlayerItem.setAttribute('data-player-address', data.player_address);
        newPlayerItem.innerHTML = `<span>${data.player_address}</span><span class="score">Score: ${data.score}</span>`;
        leaderboardList.appendChild(newPlayerItem);
    } else {
        playerItem.querySelector('.score').textContent = `Score: ${data.score}`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    startTimer(); // Ensure the timer starts as soon as the page is ready
});

const socket = io('/game');

socket.on('game_started', function(data) {
    if (data.game_id === gameId) {
        alert('The game has started!');
    }
});

socket.on('player_score_update', function(data) {
    if (data.game_id === gameId) {
        updateLeaderboard(data);
    }
});

socket.on('game_complete', function(data) {
    if (data.game_id === gameId) {
        clearInterval(timer);
        alert('Game has ended! Redirecting to results page...');
        window.location.href = "{{ url_for('main.game_result', game_id=game.id) }}";
    }
});

socket.on('connect_error', function(err) {
    console.error('Connection Error: ', err);
    alert('Unable to connect to the game server. Please refresh the page and try again.');
});
</script>
{% endblock %}
