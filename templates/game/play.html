{% extends 'base.html' %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Game #{{ game.id }}</h1>

<div id="timer" class="text-2xl font-bold mb-4">Time left: <span id="countdown"></span></div>

<form id="answer-form" action="{{ url_for('submit_answers', game_id=game.id) }}" method="POST">
    {% for question in questions %}
    <div class="mb-4">
        <label class="block text-gray-700 text-sm font-bold mb-2" for="question-{{ question.id }}">
            {{ question.phrase }}
        </label>
        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
               id="question-{{ question.id }}" 
               name="answers[]" 
               type="text" 
               placeholder="Your answer">
    </div>
    {% endfor %}
    <input type="hidden" name="ethereum_address" id="ethereum-address" value="">
    <button id="submit-answers-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" 
            type="submit">
        Submit Answers
    </button>
</form>

<div id="leaderboard" class="mt-8">
    <h2 class="text-2xl font-bold mb-4">Leaderboard</h2>
    <ul id="player-scores" class="bg-white shadow-md rounded px-8 pt-6 pb-8">
        <!-- Player scores will be added here dynamically -->
    </ul>
</div>

{% endblock %}

{% block extra_js %}
<script>
let timer;
let timeLeft = {{ game.time_limit }};
const gameId = {{ game.id }};

function startTimer() {
    timer = setInterval(function() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        
        document.getElementById('countdown').textContent = 
            (minutes < 10 ? "0" + minutes : minutes) + ":" + 
            (seconds < 10 ? "0" + seconds : seconds);
        
        if (--timeLeft < 0) {
            clearInterval(timer);
            submitAnswers();
        }
    }, 1000);
}

function submitAnswers() {
    const form = document.getElementById('answer-form');
    const formData = new FormData(form);
    
    console.log('Submitting answers for game:', gameId);
    console.log('Form action:', form.action);
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Server response:', data);
        alert(data.message);
        if (data.game_complete) {
            window.location.href = "{{ url_for('game_result', game_id=game.id) }}";
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while submitting answers. Please try again.');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Set the Ethereum address (you may want to get this from the user or session)
    document.getElementById('ethereum-address').value = 'PLACEHOLDER_ADDRESS';

    startTimer();

    const submitButton = document.getElementById('submit-answers-btn');
    if (submitButton) {
        submitButton.addEventListener('click', function(e) {
            e.preventDefault();
            submitAnswers();
        });
    } else {
        console.error('Submit button not found');
    }

    const socket = io('/game');
    socket.emit('join', { game_id: gameId });

    socket.on('player_score_update', function(data) {
        if (data.game_id === gameId) {
            updateLeaderboard(data);
        }
    });

    socket.on('game_complete', function(data) {
        if (data.game_id === gameId) {
            clearInterval(timer);
            alert('Game has ended! Redirecting to results page...');
            window.location.href = "{{ url_for('game_result', game_id=game.id) }}";
        }
    });
});

function updateLeaderboard(data) {
    const playerScores = document.getElementById('player-scores');
    const playerItem = playerScores.querySelector(`[data-player-id="${data.player_id}"]`);
    
    if (playerItem) {
        playerItem.querySelector('.score').textContent = data.score;
    } else {
        const newPlayerItem = document.createElement('li');
        newPlayerItem.className = 'mb-2';
        newPlayerItem.setAttribute('data-player-id', data.player_id);
        newPlayerItem.innerHTML = `Player ${data.player_id}: <span class="score">${data.score}</span>`;
        playerScores.appendChild(newPlayerItem);
    }

    // Sort the leaderboard
    const players = Array.from(playerScores.children);
    players.sort((a, b) => {
        const scoreA = parseInt(a.querySelector('.score').textContent);
        const scoreB = parseInt(b.querySelector('.score').textContent);
        return scoreB - scoreA;
    });
    players.forEach(player => playerScores.appendChild(player));
}
</script>
{% endblock %}
