{% extends 'base.html' %}

{% block content %}
<h1 class="text-5xl font-bold text-center text-white mb-12">Game Lobby</h1>

<div class="info-container game-lobby-info" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h2 class="text-2xl font-bold mb-4 neon-text">Game #{{ game.id }}</h2>
        <p class="mb-2 text-white">Pot Size: ${{ "%.2f"|format(game.pot_size) }}</p>
        <p class="mb-2 text-white">Entry Value: ${{ "%.2f"|format(game.entry_value) }}</p>
        <p class="mb-2 text-white">Players: <span id="player-count">{{ players|length }}</span> / {{ game.max_players }}</p>
    </div>
    <div class="countdown-wrapper">
        <span id="countdown" class="neon-clock" data-start-time="{{ game.start_time.isoformat() }}"></span>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
function updateCountdown() {
    const startTimeElement = document.getElementById('countdown');
    const startTime = new Date(startTimeElement.dataset.startTime);
    const now = new Date();
    const timeLeft = startTime - now;

    if (timeLeft <= 0) {
        console.log("Countdown finished, game should start now.");
        startTimeElement.textContent = "Game has started!";
        clearInterval(timer); // Clear the interval once the game starts
        setTimeout(function() {
            console.log("Redirecting to the game play page.");
            window.location.href = "{{ url_for('main.play_game', game_id=game.id) }}";
        }, 1000); // Add a delay for smoother UX
    } else {
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        startTimeElement.textContent = (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds);
    }
}

// Ensure the countdown is updated every second
let timer = setInterval(updateCountdown, 1000);

let socket = io('/game');
socket.on('connect', function() {
    console.log('Connected to server');
    socket.emit('join', { game_id: {{ game.id }} });
});

socket.on('connect_error', function(error) {
    console.error('Connection error:', error);
});

socket.on('player_joined', function(data) {
    if (data.game_id === {{ game.id }}) {
        const playerCount = document.getElementById('player-count');
        playerCount.textContent = data.player_count;
        console.log("Player joined, player count updated.");
    }
});

socket.on('game_started', function(data) {
    console.log("Game started event received for game", data.game_id);
    if (data.game_id === {{ game.id }}) {
        console.log("Executing redirect to the play game page.");
        setTimeout(function() {
            window.location.href = "{{ url_for('main.play_game', game_id=game.id) }}";
        }, 1000); // Short delay for smooth UX
    }
});
</script>
{% endblock %}
